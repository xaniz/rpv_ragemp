let keycodes = [{"code": 49, "number": 1},{"code": 50, "number": 2},{"code": 51, "number": 3},{"code": 52, "number": 4},{"code": 53, "number": 5},{"code": 54, "number": 6},{"code": 55, "number": 7},{"code": 56, "number": 8},{"code": 57, "number": 9},{"code": 48, "number": 0}];
var weekDays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var active = false;
var act_app = false;
var act_call = false;
var interval, dots = '', search, callingInterval = null, timeInterval = null;
var d = new Date();

const contacts = [];
const calls = [];
const messages = [];

function initApps(apps) {
    var load = JSON.parse(apps);

    load.forEach(function(app) {
        $(".apps ul").append('<li id="app_' + app.name + '" style="background-image: url(\'apps/' + app.name + '/images/app_' + app.name + '.jpg\')" onclick="startApp(\'' + app.name + '\')"><label>' + app.appname + '</label></li>');
    });                                                                                                                     
}

function startApp(app) {
    if(app) {
        if(act_call != false) {
            $(".active_app").load("apps/" + app + "/index.html");
            $(".active_app").show();
        } else $(".active_app").load("apps/" + app + "/index.html");
        
        mp.trigger('startApp', app);
        act_app = true;
    }
}

function sortList() {
    $(".contact-area ul li").sort(function(a, b) {
        return $(a).attr('data-name').toLowerCase() < $(b).attr('data-name').toLowerCase();
    }).each(function() {
        $(".contact-area ul").prepend(this);
    })
}

function searchInContacts(text) {
    if(!text.length) return $('.contact').each(function() { $(this).removeClass('found') });
    let regex = new RegExp(text);

    $('.contact').each(function() {
        let found = regex.test($(this).attr('data-number'));

        if(found) {
            $(this).addClass('found');
        } else if($(this).hasClass('found')) $(this).removeClass('found');
    });
}

function setPhoneNumber(number) {
    $(".clock #number").text('Broj telefona: ' + number);
}

function startCall(number) {
    $('.top_icons').removeClass('activeCall deniedCall incomingCall').addClass('outgoingCall');
    $('.callPhone').show();

    act_call = {"number": number, "name": null, "duration": null, "state": "outgoing"};

    contacts.forEach((contact) => {
        if(contact.number == number) act_call.name = contact.name;
    });

    mp.trigger('startCall', number);
}

function acceptCall() {
    if(act_call != null) {
        $('.tabs').each(function() { $(this).removeClass('current'); });
        $('#callScreen').addClass('current');
        $('.calling-info label').text('(323) 555 ' + act_call.number);
        act_call.duration = 0;
        
        mp.trigger('acceptIncomingCall', act_call.number);
    }
}

function callIncoming(number) {
    act_call = {"number": number, "name": null, "duration": null, "state": "incoming"};

    contacts.forEach((contact) => {
        if(contact.number == number) act_call.name = contact.name;
    });

    if(active) startApp('phone');

    $('.top_icons').removeClass('activeCall outgoingCall deniedCall').addClass('incomingCall');
    $('.callPhone').addClass('incoming').show();
}

function denyCall() {
    $('.top_icons').removeClass('activeCall outgoingCall incomingCall').addClass('deniedCall');
    $('.callPhone').removeClass('incoming').hide();
    act_call = false;

    setTimeout(function() {
        $('.top_icons').removeClass('activeCall outgoingCall incomingCall deniedCall');
    }, 1500);

    closeApp();
    mp.trigger('cancelCall');
}

function cancelCall(forced = false) {
    $('.top_icons').removeClass('activeCall outgoingCall incomingCall deniedCall');
    $('.callPhone').removeClass('incoming').hide();
    act_call = false;

    if(forced != false) {
        $('.calling-info .call-duration').text('Poziv zavrsen');
    } else $('.calling-info .call-duration').text('Nedostupan');

    setTimeout(function() {
        $('.tabs').each(function() { $(this).removeClass('current'); });
        $('#numberField').addClass('current');
    }, 2000);

    if(callingInterval != null) {
        clearInterval(callingInterval);
        callingInterval = null;
    }
}

function showApp(app) {
    $("#app_" + app).show();
}

function hideApp(app) {
    $("#app_" + app).hide();
}

function closeApp() {
    if(act_app) {
        $(".bluetooth").fadeOut(200); 
        
        $('.app').each(function() {
            $(this).fadeOut(200);
        });
        
        act_app = false;       
        $(".active_app").empty();
    }
}

function mainmenu() {
    if(!act_call) {
        closeApp();
        mp.trigger('closeApp');
    } else {
        $(".active_app").hide();
    }
}

function checkTime(i) {
  if (i < 10) {
    i = "0" + i;
  }
  return i;
}

function getTime() {
    d = new Date();
    return d.getHours() + ':' + checkTime(d.getMinutes());
}

function startTime(time) {
    if(timeInterval != null) clearInterval(timeInterval);

    timeNow = Math.abs(time);

    timeInterval = setInterval(function() {
        timeNow += 8;

        var today = new Date(timeNow * 1000);
        var h = today.getUTCHours();
        var m = today.getUTCMinutes();
        var wd = today.getUTCDay();
        var mo = today.getUTCMonth();
        var day = today.getUTCDate();

        var tag = "th";                                                                                                       
  
        m = checkTime(m);
      
        if(day == 1) {
            tag = "st";
        } else if(day == 2) {
            tag = "nd";
        }
        
        $("#time").html(h + ":" + m);
        if(!active) $(".battery_percent").html(h + ":" + m); 
        $("#date").html(weekDays[wd] + ", " + months[mo] + " " + day + tag);
    }, 1000);
}

function addContact(conta) {
    let contact = JSON.parse(conta);

    contacts.push(contact);

    sortList();
}

function newMsg(notification ,number, msg) {
    if(notification) $(".msg").fadeIn(200); 
    if(msg.length > 43) msg = msg.substring(0,43) + '...';
    var element = $('<li><i class="fa fa-envelope-o" aria-hidden="true"></i><span><div class="notification_date"><label>(323) 555 ' + number + '</label>' + getTime() + '</div><div class="notification_msg">' + msg + '</div></span></li>');
    
    $(".notifications ul").prepend(element);
    element.animate({height: '37px'}, 500);
}

function togglePhone(toggle) {
    var percent = $(".battery").attr("value");
    
    if(toggle) {
        $(".phone").stop().animate({bottom: '0px'}, 1000);
        $(".fading").stop().fadeIn(1000);
        $(".battery_percent").stop().html(percent);
        $(".msg").fadeOut(200);
        
        if(act_call != null && act_call.duration == null && act_call.state == 'incoming') {
            startApp('phone');
        }
    } else {
        $(".phone").stop().animate({bottom: '-504px'}, 1000);
        $(".fading").stop().fadeOut(1000);
    }

    active = toggle;
}

var pusher = {
    number : function(num) {
        $('body').on('click', '.numbers-container .pushed' + num + '', function() {
            addNumber(num);
        });		
    }
}

pusher.number(1);
pusher.number(2);
pusher.number(3);
pusher.number(4);
pusher.number(5);
pusher.number(6);
pusher.number(7);
pusher.number(8);
pusher.number(9);
pusher.number(0);

$('body').on('click', '.delete-btn', function() {
    removeNumber();
});

$('body').on('click', '.numbers-container .pushedasterisk', function() {
    $('.number-area .numbers .tipped').append('*');
});	

$('body').on('click', '.numbers-container .pushednumber', function() {
    $('.number-area .numbers .tipped').append('#');
});

$('body').on('click', '.call-btn', function() {
    callNumber();
});

$('body').on('click', '.hangup-btn', function() {
    hangUp();
});

$('body').on('click', '.answer-btn', function() {
    acceptCall();
});

$('body').on('click', '.deny-btn', function() {
    denyCall();
});

$('body').on('click', '.contact', function() {
    $('.number-area .numbers .tipped').removeClass('fail').html($(this).attr('data-number'));

    searchInContacts($(this).attr('data-number'));
});

$(document).on('keypress', function(event) {
    if(!act_app) return false;
    if (event.which === 8) return removeNumber();
    if (event.which === 13) return callNumber();

    for(let i = 0; i < keycodes.length; i++) {
        if(keycodes[i].code == event.which) {
            return addNumber(keycodes[i].number);
        }
    }
});

$(document).ready(function() {
  startTime();
});

//clock

